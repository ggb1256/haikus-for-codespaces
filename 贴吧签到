/*
ç™¾åº¦è´´å§ç­¾åˆ°è„šæœ¬

è„šæœ¬ä¿®æ”¹è‡ªï¼šhttps://github.com/sazs34/TaskConfig
å…¼å®¹ï¼šQuantumultXã€Surge4ã€Loon

è·å–Cookieè¯´æ˜ï¼š
æ‰“å¼€ç™¾åº¦è´´å§Appåï¼ˆAppStoreä¸­å›½åŒºï¼Œéå†…éƒ¨ç‰ˆï¼‰ï¼Œç‚¹å‡»â€œæˆ‘çš„â€ï¼Œå¦‚é€šçŸ¥æˆåŠŸè·å–cookieï¼Œåˆ™å¯ä»¥ä½¿ç”¨æ­¤ç­¾åˆ°è„šæœ¬ã€‚
è·å–Cookieåï¼Œè¯·ç¦ç”¨Cookieè„šæœ¬å¹¶ç§»é™¤ä¸»æœºåï¼Œä»¥å…äº§ç”Ÿä¸å¿…è¦çš„MITMã€‚
è„šæœ¬å°†æ‰§è¡Œæ¯å¤©ä¸Šåˆ9:00ï¼Œå¯ä»¥ä¿®æ”¹æ‰§è¡Œæ—¶é—´ã€‚

************************
Surge 4.2.0+è„šæœ¬é…ç½®ï¼š
************************

[å‰§æœ¬]
è´´å§ç­¾åˆ° = type=cron,cronexp=0 9 * * *,script-path=https://raw.githubusercontent.com/NobyDa/Script/master/BDTieBa-DailyBonus/TieBa.js

è´´å§è·å–Cookie = type=http-request,pattern=https?:\/\/(c\.tieba\.baidu\.com|180\.97\.\d+\.\d+)\/c\/s\/login,script-path=https://raw.githubusercontent.com/NobyDa/Script/master/BDTieBa-DailyBonus/TieBa.js

[MITM]
hostname= c.tieba.baidu.com

************************
QuantumultXæœ¬åœ°è„šæœ¬é…ç½®ï¼š
************************

[task_local]
#è´´å§ç­¾åˆ°
0 9 * * * TieBa.js

[rewrite_local]
#è·å–Cookie
https?:\/\/(c\.tieba\.baidu\.com|180\.97\.\d+\.\d+)\/c\/s\/login url script-request-header TieBa.js

[mitm]
hostname= c.tieba.baidu.com

************************
Loon 2.1.0+è„šæœ¬é…ç½®ï¼š
************************

[å‰§æœ¬]
#è´´å§ç­¾åˆ°
cron "0 9 * * *" script-path=https://raw.githubusercontent.com/NobyDa/Script/master/BDTieBa-DailyBonus/TieBa.js

#è·å–Cookie
http-request https?:\/\/(c\.tieba\.baidu\.com|180\.97\.\d+\.\d+)\/c\/s\/login script-path=https://raw.githubusercontent.com/NobyDa/Script/master/BDTieBa-DailyBonus/TieBa.js

[Mitm]
hostname= c.tieba.baidu.com


*/
var $nobyda = nobyda();
var cookieVal = $nobyda.read("CookieTB");
var useParallel = 1; //0è‡ªåŠ¨åˆ‡æ¢ï¼Œ1ä¸²è¡Œï¼Œ2å¹¶è¡Œï¼ˆå½“è´´å§æ•°é‡å¤§äº30ä¸ªä»¥åï¼Œå¹¶è¡Œå¯èƒ½ä¼šå¯¼è‡´QXå´©æºƒï¼Œæ‰€ä»¥å¯ä»¥è‡ªåŠ¨åˆ‡æ¢ï¼‰
var singleNotifyCount = 99; //æƒ³ç­¾åˆ°å‡ ä¸ªæ±‡æ€»åˆ°ä¸€ä¸ªé€šçŸ¥é‡Œï¼Œè¿™é‡Œå°±å¡«å‡ ä¸ªï¼ˆä¾‹å¦‚æˆ‘æœ‰13ä¸ªè¦ç­¾åˆ°çš„ï¼Œè¿™é‡Œå¡«äº†5ï¼Œå°±ä¼šåˆ†ä¸‰æ¬¡æ¶ˆæ¯é€šçŸ¥è¿‡å»ï¼‰
var process = {
æ€»è®¡ï¼š0ï¼Œ
ç»“æœï¼š[
// {
// bar:'',
// level:0ï¼Œ
// exp:0ï¼Œ
// errorCode:0ï¼Œ
// errorMsg:''
// }
ã€‘
};
var url_fetch_sign = {
ç½‘å€ï¼š"https://tieba.baidu.com/mo/q/newmoindex",
æ ‡é¢˜ï¼š{
"å†…å®¹ç±»å‹": "åº”ç”¨ç¨‹åº/å…«å­—èŠ‚æµ",
æ¨èäººï¼šhttps://tieba.baidu.com/index/tbwise/forum",
Cookieï¼šcookieValï¼Œ
â€œç”¨æˆ·ä»£ç†â€ï¼šâ€œMozilla/5.0ï¼ˆiPhoneï¼›CPU iPhone OS 12_0ï¼Œå¦‚Mac OS Xï¼‰AppleWebKit/605.1.15ï¼ˆKHTMLï¼Œå¦‚å£è™ï¼‰Mobile/16A366â€
}
};
var url_fetch_add = {
ç½‘å€ï¼š"https://tieba.baidu.com/sign/add",
æ–¹æ³•ï¼š"POST",
æ ‡é¢˜ï¼š{
"å†…å®¹ç±»å‹": "application/x-www-form-urlencoded",
Cookieï¼šcookieValï¼Œ
â€œç”¨æˆ·ä»£ç†â€ï¼šâ€œMozilla/5.0ï¼ˆiPhoneï¼›CPU iPhone OS 10_1_1ï¼Œå¦‚Mac OS Xï¼›zh-CNï¼‰AppleWebKit/537.51.1ï¼ˆKHTMLï¼Œå¦‚Geckoï¼‰Mobile/14B100 UCBrowser/10.7.5.650 Mobileâ€
}ï¼Œ
èº«ä½“ï¼š""
};
if ($nobyda.isRequest) {
GetCookieï¼ˆï¼‰
} else {
signTieBaï¼ˆï¼‰
}


å‡½æ•°signTieBa() {
useParallel = $nobyda.read("BDTB_DailyBonus_Mode") || useParallel
singleNotifyCount = $nobyda.read("BDTB_DailyBonus_notify") || singleNotifyCount
å¦‚æœï¼ˆï¼cookieValï¼‰{
$nobyda.notify("è´´å§ç­¾åˆ°", "ç­¾åˆ°å¤±è´¥", "æœªè·å–åˆ°cookie");
è¿”å›$nobyda.done()
}
$nobyda.get(url_fetch_sign, function(error, response, data) {
å¦‚æœï¼ˆé”™è¯¯ï¼‰{
$nobyda.notify("è´´å§ç­¾åˆ°", "ç­¾åˆ°å¤±è´¥", "æœªè·å–åˆ°ç­¾åˆ°åˆ—è¡¨");
$nobyda.doneï¼ˆï¼‰
} else {
// $nobyda.notify("è´´å§ç­¾åˆ°", "è´´å§åˆ—è¡¨", response.body);
var body = JSON.parseï¼ˆæ•°æ®ï¼‰ï¼›
var isSuccessResponse = body && body.no == 0 && body.error == "success" && body.data.tbs;
å¦‚æœï¼ˆï¼isSuccessResponse) {
$nobyda.notify("è´´å§ç­¾åˆ°", "ç­¾åˆ°å¤±è´¥", (body && body.error) ?body.errorï¼šâ€œæ¥å£æ•°æ®è·å–å¤±è´¥â€ï¼‰ï¼›
è¿”å›$nobyda.done()
}
process.total = body.data.like_forum.length;
if (body.data.like_forum && body.data.like_forum.length > 0) {
if (useParallel == 1 || (useParallel == 0 && body.data.like_forum.length >= 30)) {
signBarsï¼ˆbody.data.like_forumï¼Œbody.data.tbsï¼Œ0ï¼‰ï¼›
} else {
for (const bar of body.data.like_forum) {
signBarï¼ˆbarï¼Œbody.data.tbsï¼‰ï¼›
}
}
} else {
$nobyda.notify("è´´å§ç­¾åˆ°", "ç­¾åˆ°å¤±è´¥", "è¯·ç¡®è®¤ä½ æœ‰å…³æ³¨çš„è´´å§");
è¿”å›$nobyda.done()
}
}
}ï¼‰
}

function signBar(bar, tbs) {
if (bar.is_sign == 1) { // å·²ç­¾åˆ°çš„,ç›´æ¥ä¸è¯·æ±‚æ¥å£äº†
process.result.pushï¼ˆ{
bar: `${bar.forum_name}``,
çº§åˆ«ï¼šbar.user_levelï¼Œ
expï¼šbar.user_expï¼Œ
é”™è¯¯ä»£ç ï¼š9999ï¼Œ
errorMsgï¼šâ€œå·²ç­¾åˆ°â€
}ï¼‰ï¼›
checkIsAllProcessed();
} else {
url_fetch_add.body = `tbs=${tbs}&kw=${bar.forum_name}&ie=utf-8`;
$nobyda.post(url_fetch_add, function(error, response, data) {
å¦‚æœï¼ˆé”™è¯¯ï¼‰{
process.result.pushï¼ˆ{
barï¼šbar.forum_nameï¼Œ
é”™è¯¯ä»£ç ï¼š999ï¼Œ
errorMsgï¼š'æ¥å£é”™è¯¯'
}ï¼‰ï¼›
checkIsAllProcessed();
} else {
å°è¯•{
var addResult = JSON.parseï¼ˆæ•°æ®ï¼‰ï¼›
if (addResult.no == 0) {
process.result.pushï¼ˆ{
barï¼šbar.forum_nameï¼Œ
é”™è¯¯ä»£ç ï¼š0ï¼Œ
errorMsg: `è·å¾—${addResult.data.uinfo.cont_sign_num}ç§¯åˆ†ï¼Œç¬¬${addResult.data.uinfo.user_sign_rank}ä¸ªç­¾åˆ°`
}ï¼‰ï¼›
} else {
process.result.pushï¼ˆ{
barï¼šbar.forum_nameï¼Œ
errorCodeï¼šaddResult.noï¼Œ
errorMsgï¼šaddResult.error
}ï¼‰ï¼›
}
} catch (e) {
$nobyda.notify("è´´å§ç­¾åˆ°", "è´´å§ç­¾åˆ°æ•°æ®å¤„ç†å¼‚å¸¸", JSON.stringify(e));
$nobyda.doneï¼ˆï¼‰
}
checkIsAllProcessed();
}
}ï¼‰
}
}

åŠŸèƒ½æ ‡å¿—æ ï¼ˆbarsï¼Œtbsï¼Œç´¢å¼•ï¼‰{
//$nobyda.notify("è´´å§ç­¾åˆ°", `è¿›åº¦${index}/${bars.length}`, "");
å¦‚æœï¼ˆç´¢å¼•>= bars.lengthï¼‰{
//$nobyda.notify("è´´å§ç­¾åˆ°", "ç­¾åˆ°å·²æ»¡", `${process.result.length}`);
checkIsAllProcessed();
} else {
var bar = bars[index];
if (bar.is_sign == 1) { // å·²ç­¾åˆ°çš„,ç›´æ¥ä¸è¯·æ±‚æ¥å£äº†
process.result.pushï¼ˆ{
bar: `${bar.forum_name}``,
çº§åˆ«ï¼šbar.user_levelï¼Œ
expï¼šbar.user_expï¼Œ
é”™è¯¯ä»£ç ï¼š9999ï¼Œ
errorMsgï¼šâ€œå·²ç­¾åˆ°â€
}ï¼‰ï¼›
signBarsï¼ˆbarsï¼Œtbsï¼Œ++indexï¼‰ï¼›
} else {
url_fetch_add.body = `tbs=${tbs}&kw=${bar.forum_name}&ie=utf-8`;
$nobyda.post(url_fetch_add, function(error, response, data) {
å¦‚æœï¼ˆé”™è¯¯ï¼‰{
process.result.pushï¼ˆ{
barï¼šbar.forum_nameï¼Œ
é”™è¯¯ä»£ç ï¼š999ï¼Œ
errorMsgï¼š'æ¥å£é”™è¯¯'
}ï¼‰ï¼›
signBarsï¼ˆbarsï¼Œtbsï¼Œ++indexï¼‰ï¼›
} else {
å°è¯•{
var addResult = JSON.parseï¼ˆæ•°æ®ï¼‰ï¼›
if (addResult.no == 0) {
process.result.pushï¼ˆ{
barï¼šbar.forum_nameï¼Œ
é”™è¯¯ä»£ç ï¼š0ï¼Œ
errorMsg: `è·å¾—${addResult.data.uinfo.cont_sign_num}ç§¯åˆ†ï¼Œç¬¬${addResult.data.uinfo.user_sign_rank}ä¸ªç­¾åˆ°`
}ï¼‰ï¼›
} else {
process.result.pushï¼ˆ{
barï¼šbar.forum_nameï¼Œ
errorCodeï¼šaddResult.noï¼Œ
errorMsgï¼šaddResult.error
}ï¼‰ï¼›
}
} catch (e) {
$nobyda.notify("è´´å§ç­¾åˆ°", "è´´å§ç­¾åˆ°æ•°æ®å¤„ç†å¼‚å¸¸", JSON.stringify(e));
$nobyda.doneï¼ˆï¼‰
}
signBarsï¼ˆbarsï¼Œtbsï¼Œ++indexï¼‰
}
}ï¼‰
}
}
}

å‡½æ•°checkIsAllProcessed() {
//$nobyda.notify("è´´å§ç­¾åˆ°", `æœ€ç»ˆè¿›åº¦${process.result.length}/${process.total}`, "");
å¦‚æœï¼ˆprocess.result.lengthï¼= process.totalï¼‰è¿”å›ï¼›
for (var i = 0; i < Math.ceil(process.total / singleNotifyCount); i++) {
var notify = "";
var spliceArr = process.result.splice(0, singleNotifyCount);
var notifySuccessCount = 0;
for (const res of spliceArr) {
if (res.errorCode == 0 || res.errorCode == 9999) {
é€šçŸ¥æˆåŠŸè®¡æ•°++;
}
if (res.errorCode == 9999) {
é€šçŸ¥+= `ã€${res.bar}ã€‘å·²ç­¾åˆ°ï¼Œå½“å‰ç­‰çº§${res.level}ï¼Œç»éªŒ${res.exp}
`;
} else {
é€šçŸ¥+= `ã€${res.bar}ã€‘${res.errorCode==0?'ç­¾åˆ°æˆåŠŸ':'ç­¾åˆ°å¤±è´¥'}ï¼Œ${res.errorCode==0?res.errorMsg:('åŸå› ï¼š'+res.errorMsg)}
`;
}
}
$nobyda.notify("è´´å§ç­¾åˆ°", `ç­¾åˆ°${spliceArr.length}ä¸ª,æˆåŠŸ${notifySuccessCount}ä¸ª`, notify);
$nobyda.doneï¼ˆï¼‰
}
}

å‡½æ•° GetCookie() {
var headerCookie = $request.headers["Cookie"];
if (headerCookie) {
å¦‚æœï¼ˆ$nobyda.readï¼ˆâ€œCookieTBâ€ï¼‰ï¼= undefinedï¼‰{
å¦‚æœï¼ˆ$nobyda.readï¼ˆâ€œCookieTBâ€ï¼‰ï¼= headerCookieï¼‰{
å¦‚æœï¼ˆheaderCookie.indexOfï¼ˆâ€œBDUSSâ€ï¼‰ï¼= -1) {
var cookie = $nobyda.writeï¼ˆheaderCookieï¼Œ"CookieTB"ï¼‰ï¼›
å¦‚æœï¼ˆï¼é¥¼å¹²ï¼‰{
$nobyda.notify("æ›´æ–°è´´å§Cookieå¤±è´¥!!ï¸", "", "");
} else {
$nobyda.notify("æ›´æ–°è´´å§CookieæˆåŠŸğŸ‰", "", "")
}
}
}
} else {
å¦‚æœï¼ˆheaderCookie.indexOfï¼ˆâ€œBDUSSâ€ï¼‰ï¼= -1) {
var cookie = $nobyda.writeï¼ˆheaderCookieï¼Œ"CookieTB"ï¼‰ï¼›
å¦‚æœï¼ˆï¼é¥¼å¹²ï¼‰{
$nobyda.notify("é¦–æ¬¡å†™å…¥è´´å§Cookieå¤±è´¥!!ï¸", "", "");
} else {
$nobyda.notify("é¦–æ¬¡å†™å…¥è´´å§CookieæˆåŠŸğŸ‰", "", "")
}
}
}
}
$nobyda.doneï¼ˆï¼‰
}

function nobyda() {
const isRequest = $requestçš„ç±»å‹ï¼= "æœªå®šä¹‰"
const isSurge = $httpClientçš„ç±»å‹ï¼= "æœªå®šä¹‰"
const isQuanX = $taskçš„ç±»å‹ï¼= "æœªå®šä¹‰"
const notify = (title, subtitle, message) => {
å¦‚æœï¼ˆisQuanXï¼‰$notifyï¼ˆæ ‡é¢˜ï¼Œå‰¯æ ‡é¢˜ï¼Œæ¶ˆæ¯ï¼‰
if (isSurge) $notification.post(title, subtitle, message)
}
const write = (value, key) => {
å¦‚æœï¼ˆisQuanXï¼‰è¿”å›$prefs.setValueForKeyï¼ˆå€¼ï¼Œé”®ï¼‰
å¦‚æœï¼ˆisSurgeï¼‰è¿”å›$persistentStore.writeï¼ˆå€¼ï¼Œé”®ï¼‰
}
const read = (key) => {
å¦‚æœï¼ˆisQuanXï¼‰è¿”å›$prefs.valueForKeyï¼ˆkeyï¼‰
å¦‚æœï¼ˆisSurgeï¼‰è¿”å›$persistentStore.readï¼ˆå¯†é’¥ï¼‰
}
const adapterStatus = (response) => {
å¦‚æœï¼ˆå›å¤ï¼‰{
if (response.status) {
response["statusCode"] = response.status
} else if (response.statusCode) {
response["status"] = response.statusCode
}
}
é€€è´§å›å¤
}
const get =ï¼ˆé€‰é¡¹ï¼Œå›è°ƒï¼‰=> {
if (isQuanX) {
if (typeof options == "string") options = {
urlï¼šé€‰é¡¹
}
options["method"] = "GET"
$task.fetch(options).then(response => {
å›è°ƒï¼ˆnullï¼Œé€‚é…å™¨çŠ¶æ€ï¼ˆresponseï¼‰ï¼Œresponse.bodyï¼‰
}, reason => callback(reason.error, null, null))
}
if (isSurge) $httpClient.get(options, (error, response, body) => {
å›è°ƒï¼ˆé”™è¯¯ï¼Œé€‚é…å™¨çŠ¶æ€ï¼ˆå“åº”ï¼‰ï¼Œæ­£æ–‡ï¼‰
}ï¼‰
}
const post = (options, callback) => {
if (isQuanX) {
if (typeof options == "string") options = {
urlï¼šé€‰é¡¹
}
options["method"] = "POST"
$task.fetch(options).then(response => {
å›è°ƒï¼ˆnullï¼Œé€‚é…å™¨çŠ¶æ€ï¼ˆresponseï¼‰ï¼Œresponse.bodyï¼‰
}, reason => callback(reason.error, null, null))
}
if (isSurge) {
$httpClient.post(options, (error, response, body) => {
å›è°ƒï¼ˆé”™è¯¯ï¼Œé€‚é…å™¨çŠ¶æ€ï¼ˆå“åº”ï¼‰ï¼Œæ­£æ–‡ï¼‰
}ï¼‰
}
}
const done = (value = {}) => {
å¦‚æœï¼ˆisQuanXï¼‰è¿”å›$doneï¼ˆä»·å€¼ï¼‰
å¦‚æœï¼ˆisSurgeï¼‰æ˜¯è¯·æ±‚ï¼Ÿ$doneï¼ˆä»·å€¼ï¼‰ï¼š$doneï¼ˆï¼‰
}
è¿”å›{
æ˜¯è¯·æ±‚ï¼Œ
é€šçŸ¥ï¼Œ
å†™ï¼Œ
é˜…è¯»ï¼Œ
å¾—åˆ°ï¼Œ
å¸–å­ï¼Œ
å®Œæˆ
}
};
